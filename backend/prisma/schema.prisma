// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANCY E AUTENTICAÇÃO
// ============================================

model Company {
  id        String   @id @default(uuid())
  name      String
  cnpj      String?  @unique
  email     String
  phone     String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  logo      String?
  isActive  Boolean  @default(true)
  plan      Plan     @default(BASIC)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  users           User[]
  customers       Customer[]
  suppliers       Supplier[]
  products        Product[]
  categories      Category[]
  sales           Sale[]
  purchases       Purchase[]
  serviceOrders   ServiceOrder[]
  accountsPayable AccountPayable[]
  accountsReceivable AccountReceivable[]
  cashFlows       CashFlow[]
  inventoryMovements InventoryMovement[]
  nfse            Nfse[]

  // Dados fiscais para emissão de NFS-e
  inscricaoMunicipal String?
  codigoMunicipio    String? // Código IBGE do município
  regimeTributacao   Int? // 1-Simples Nacional, 2-Fixo, 3-Estimativa, 4-S.Normal
  optanteSimplesNacional Boolean @default(false)
  incentivadorCultural Boolean @default(false)

  @@index([cnpj])
  @@map("companies")
}

enum Plan {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(USER)
  isActive  Boolean  @default(true)
  avatar    String?
  phone     String?
  companyId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sales     Sale[]
  serviceOrders ServiceOrder[]
  cashFlows CashFlow[]

  @@index([companyId])
  @@index([email])
  @@map("users")
}

enum Role {
  ADMIN       // Administrador do sistema
  MANAGER     // Gerente da empresa
  USER        // Usuário comum
  SALESPERSON // Vendedor
  CASHIER     // Caixa
  TECHNICIAN  // Técnico
}

// ============================================
// CLIENTES E FORNECEDORES
// ============================================

model Customer {
  id        String   @id @default(uuid())
  name      String
  email     String?
  phone     String?
  cpf       String?
  cnpj      String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  notes     String?
  creditLimit Decimal? @db.Decimal(10, 2)
  isActive  Boolean  @default(true)
  companyId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sales     Sale[]
  serviceOrders ServiceOrder[]
  accountsReceivable AccountReceivable[]
  nfse      Nfse[]

  @@index([companyId])
  @@index([cpf])
  @@index([cnpj])
  @@map("customers")
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  email     String?
  phone     String?
  cnpj      String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  notes     String?
  isActive  Boolean  @default(true)
  companyId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  purchases Purchase[]
  accountsPayable AccountPayable[]

  @@index([companyId])
  @@index([cnpj])
  @@map("suppliers")
}

// ============================================
// PRODUTOS E ESTOQUE
// ============================================

model Category {
  id          String   @id @default(uuid())
  name        String
  description String?
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([companyId])
  @@map("categories")
}

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  sku         String?
  barcode     String?
  price       Decimal  @db.Decimal(10, 2)
  cost        Decimal? @db.Decimal(10, 2)
  stock       Int      @default(0)
  minStock    Int      @default(0)
  maxStock    Int?
  unit        String   @default("UN") // UN, KG, L, M, etc
  isActive    Boolean  @default(true)
  categoryId  String?
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category   Category?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  saleItems  SaleItem[]
  purchaseItems PurchaseItem[]
  serviceOrderItems ServiceOrderItem[]
  inventoryMovements InventoryMovement[]

  @@index([companyId])
  @@index([categoryId])
  @@index([sku])
  @@index([barcode])
  @@map("products")
}

model InventoryMovement {
  id          String   @id @default(uuid())
  type        MovementType
  quantity    Int
  notes       String?
  productId   String
  companyId   String
  createdAt   DateTime @default(now())

  // Relacionamentos
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([productId])
  @@map("inventory_movements")
}

enum MovementType {
  ENTRY      // Entrada
  EXIT       // Saída
  ADJUSTMENT // Ajuste
  RETURN     // Devolução
}

// ============================================
// VENDAS E PDV
// ============================================

model Sale {
  id          String   @id @default(uuid())
  saleNumber  String
  date        DateTime @default(now())
  status      SaleStatus @default(COMPLETED)
  subtotal    Decimal  @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  notes       String?
  customerId  String?
  userId      String
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  company  Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)
  user     User       @relation(fields: [userId], references: [id])
  items    SaleItem[]

  @@index([companyId])
  @@index([customerId])
  @@index([userId])
  @@index([saleNumber])
  @@map("sales")
}

model SaleItem {
  id        String  @id @default(uuid())
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  discount  Decimal @default(0) @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(10, 2)
  saleId    String
  productId String

  // Relacionamentos
  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

enum SaleStatus {
  PENDING    // Pendente/Orçamento
  COMPLETED  // Concluída
  CANCELLED  // Cancelada
}

enum PaymentMethod {
  CASH       // Dinheiro
  DEBIT_CARD // Cartão de débito
  CREDIT_CARD // Cartão de crédito
  PIX        // PIX
  BANK_SLIP  // Boleto
  CHECK      // Cheque
  OTHER      // Outro
}

// ============================================
// COMPRAS
// ============================================

model Purchase {
  id          String   @id @default(uuid())
  purchaseNumber String
  date        DateTime @default(now())
  status      PurchaseStatus @default(PENDING)
  subtotal    Decimal  @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  notes       String?
  supplierId  String?
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  company  Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier Supplier?      @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  items    PurchaseItem[]

  @@index([companyId])
  @@index([supplierId])
  @@index([purchaseNumber])
  @@map("purchases")
}

model PurchaseItem {
  id         String  @id @default(uuid())
  quantity   Int
  price      Decimal @db.Decimal(10, 2)
  subtotal   Decimal @db.Decimal(10, 2)
  purchaseId String
  productId  String

  // Relacionamentos
  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id])

  @@index([purchaseId])
  @@index([productId])
  @@map("purchase_items")
}

enum PurchaseStatus {
  PENDING   // Pendente
  RECEIVED  // Recebida
  CANCELLED // Cancelada
}

// ============================================
// SERVIÇOS
// ============================================

model ServiceOrder {
  id          String   @id @default(uuid())
  orderNumber String
  date        DateTime @default(now())
  status      ServiceStatus @default(PENDING)
  description String
  diagnosis   String?
  solution    String?
  subtotal    Decimal  @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  customerId  String?
  technicianId String?
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  company    Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer   Customer?            @relation(fields: [customerId], references: [id], onDelete: SetNull)
  technician User?                @relation(fields: [technicianId], references: [id], onDelete: SetNull)
  items      ServiceOrderItem[]
  nfse       Nfse[]

  @@index([companyId])
  @@index([customerId])
  @@index([technicianId])
  @@index([orderNumber])
  @@map("service_orders")
}

model ServiceOrderItem {
  id             String  @id @default(uuid())
  type           ServiceItemType
  description    String
  quantity       Int     @default(1)
  price          Decimal @db.Decimal(10, 2)
  subtotal       Decimal @db.Decimal(10, 2)
  serviceOrderId String
  productId      String?

  // Relacionamentos
  serviceOrder ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)
  product      Product?     @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([serviceOrderId])
  @@index([productId])
  @@map("service_order_items")
}

enum ServiceItemType {
  SERVICE // Serviço
  PRODUCT // Produto/Peça
}

enum ServiceStatus {
  PENDING     // Pendente
  IN_PROGRESS // Em andamento
  COMPLETED   // Concluído
  DELIVERED   // Entregue
  CANCELLED   // Cancelado
}

// ============================================
// FINANCEIRO
// ============================================

model AccountPayable {
  id          String   @id @default(uuid())
  description String
  amount      Decimal  @db.Decimal(10, 2)
  dueDate     DateTime
  paymentDate DateTime?
  status      AccountStatus @default(PENDING)
  category    String?
  notes       String?
  supplierId  String?
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([supplierId])
  @@index([status])
  @@map("accounts_payable")
}

model AccountReceivable {
  id          String   @id @default(uuid())
  description String
  amount      Decimal  @db.Decimal(10, 2)
  dueDate     DateTime
  paymentDate DateTime?
  status      AccountStatus @default(PENDING)
  category    String?
  notes       String?
  customerId  String?
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("accounts_receivable")
}

enum AccountStatus {
  PENDING  // Pendente
  PAID     // Pago
  OVERDUE  // Vencido
  CANCELLED // Cancelado
}

model CashFlow {
  id          String   @id @default(uuid())
  type        CashFlowType
  amount      Decimal  @db.Decimal(10, 2)
  description String
  category    String?
  date        DateTime @default(now())
  userId      String
  companyId   String
  createdAt   DateTime @default(now())

  // Relacionamentos
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@index([userId])
  @@index([type])
  @@map("cash_flows")
}

enum CashFlowType {
  INCOME  // Entrada
  EXPENSE // Saída
}

// ============================================
// NFS-e (Nota Fiscal de Serviço Eletrônica)
// ============================================

model Nfse {
  id          String   @id @default(uuid())
  numero      String?  // Número da NFS-e após emissão
  codigoVerificacao String? // Código de verificação da nota
  status      NfseStatus @default(RASCUNHO)
  dataEmissao DateTime?
  competencia DateTime @default(now()) // Mês/ano da prestação do serviço

  // RPS (Recibo Provisório de Serviço)
  numeroRps   String
  serieRps    String @default("RPS")
  tipoRps     Int @default(1) // 1-RPS, 2-Nota Fiscal Conjugada (Mista), 3-Cupom

  // Prestador (sempre a empresa)
  companyId   String

  // Tomador (cliente)
  customerId  String?
  tomadorCpfCnpj String?
  tomadorNome String
  tomadorEmail String?
  tomadorTelefone String?
  tomadorEndereco String?
  tomadorNumero String?
  tomadorComplemento String?
  tomadorBairro String?
  tomadorCidade String?
  tomadorUf String?
  tomadorCep String?
  tomadorCodigoMunicipio String?

  // Serviço
  serviceOrderId String?
  descricaoServico String
  codigoServico String // Código do serviço na lista da prefeitura
  codigoCnae String?
  codigoTributacaoMunicipio String?

  // Valores
  valorServicos Decimal @db.Decimal(10, 2)
  valorDeducoes Decimal @default(0) @db.Decimal(10, 2)
  valorPis Decimal @default(0) @db.Decimal(10, 2)
  valorCofins Decimal @default(0) @db.Decimal(10, 2)
  valorInss Decimal @default(0) @db.Decimal(10, 2)
  valorIr Decimal @default(0) @db.Decimal(10, 2)
  valorCsll Decimal @default(0) @db.Decimal(10, 2)
  outrasRetencoes Decimal @default(0) @db.Decimal(10, 2)
  valorIss Decimal @default(0) @db.Decimal(10, 2)
  aliquotaIss Decimal @default(0) @db.Decimal(5, 2)
  descontoIncondicionado Decimal @default(0) @db.Decimal(10, 2)
  descontoCondicionado Decimal @default(0) @db.Decimal(10, 2)
  baseCalculo Decimal @db.Decimal(10, 2)
  valorLiquidoNfse Decimal @db.Decimal(10, 2)

  // ISS
  issRetido Boolean @default(false)
  responsavelRetencao Int? // 1-Tomador, 2-Intermediário
  itemListaServico String // Ex: 07.02
  discriminacao String // Discriminação do serviço
  municipioIncidencia String? // Código do município de incidência do ISS

  // Informações adicionais
  observacoes String?

  // Protocolo e XML
  protocolo String? // Protocolo de envio
  xmlEnvio String? @db.Text // XML enviado
  xmlRetorno String? @db.Text // XML de retorno
  mensagemErro String?

  // Relacionamentos
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  serviceOrder ServiceOrder? @relation(fields: [serviceOrderId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([customerId])
  @@index([serviceOrderId])
  @@index([numero])
  @@index([numeroRps])
  @@index([status])
  @@map("nfse")
}

enum NfseStatus {
  RASCUNHO      // Ainda não enviada
  ENVIADA       // Enviada para processamento
  AUTORIZADA    // Autorizada pela prefeitura
  CANCELADA     // Cancelada
  ERRO          // Erro no processamento
}
